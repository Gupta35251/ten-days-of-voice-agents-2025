<!DOCTYPE html>
<html>
<head>
    <title>Brewtastic Barista</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', Arial, sans-serif;
        background: linear-gradient(120deg, #f5e9cd 0, #c8e6e7 100%);
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 480px;
        margin: 40px auto;
        background: #ffffffed;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        border-radius: 18px;
        padding: 32px;
      }
      h2 {
        font-size: 2.4em;
        font-weight: 700;
        color: #4a705a;
        text-align: center;
        margin-bottom: 12px;
        letter-spacing: 0.04em;
      }
      #dialog {
        margin-top: 1em;
        font-size: 1.18em;
        color: #333;
        min-height: 32px;
        font-weight: 500;
        margin-bottom: 10px;
        line-height: 1.3em;
      }
      .input-section {
        display: flex;
        gap: 8px;
        margin-bottom: 18px;
        align-items: center;
      }
      #input {
        flex: 1;
        border: 1px solid #9ecaaa;
        border-radius: 6px;
        padding: 9px;
        font-size: 1em;
      }
      button {
        height: 38px;
        border: none;
        border-radius: 8px;
        background: #54b78c;
        color: #fff;
        font-size: 1em;
        font-weight: 500;
        padding: 0 18px;
        cursor: pointer;
        transition: background 0.2s;
      }
      button[disabled], #sendBtn[disabled] {
        cursor: not-allowed;
        background: #c7d9cf !important;
        color: #888 !important;
      }
      #voiceBtn {
        background: #e7b358;
        color: #4a3322;
        padding: 0 14px;
      }
      #newOrderBtn {
        background: #7a99de;
        color: #fff;
        margin-left: 0;
      }
      #summary {
        margin-top: 1.5em;
        background: #f9fafb;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #d0e1dd;
        font-size: 1em;
      }
    </style>
</head>
<body>
    <div class="container">
      <h2>Coffee Shop Barista Agent Demo</h2>
      <div id="dialog"></div>
      <div class="input-section">
        <input type="text" id="input" placeholder="Type your answer...">
        <button id="sendBtn" onclick="sendAnswer()">&#x1F4E4; Send</button>
        <button id="voiceBtn">&#x1F3A4; Speak</button>
      </div>
      <button id="newOrderBtn" style="display:none;" onclick="resetOrder()">&#x1F504; New Order</button>
      <pre id="summary"></pre>
    </div>

    <script>
    let update_key = '';

    // Speech Recognition (Voice input)
    let recognition = null;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onresult = function(event) {
        let transcript = event.results[0][0].transcript;
        document.getElementById('input').value = transcript;
      };
    }
    document.getElementById('voiceBtn').onclick = function () {
      if (recognition) recognition.start();
    };

    // Speech Synthesis (Agent replies spoken aloud)
    function speakText(text) {
        let synth = window.speechSynthesis;
        let utter = new SpeechSynthesisUtterance(text);
        synth.speak(utter);
    }

    // Start agent conversation
    window.onload = function () {
        sendAnswer(true);
    };

    function sendAnswer(init = false) {
        let inputBox = document.getElementById('input');
        let sendBtn = document.getElementById('sendBtn');
        let voiceBtn = document.getElementById('voiceBtn');
        let answer = init ? '' : inputBox.value;

        fetch('http://127.0.0.1:5000/order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                answer: answer,
                update_key: update_key
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not ok " + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('dialog').innerText = data.question;
            speakText(data.question);

            if (!data.done) {
                update_key = data.update_key;
                inputBox.value = '';
                document.getElementById('summary').innerText =
                    JSON.stringify(data.order_state, null, 2);
            } else {
                document.getElementById('summary').innerText =
                    JSON.stringify(data.order_state, null, 2);

                inputBox.style.display = 'none';
                voiceBtn.style.display = 'none';
                sendBtn.textContent = 'Order Complete';
                sendBtn.disabled = true;
                document.getElementById('newOrderBtn').style.display = '';
            }
        })
        .catch(error => {
            document.getElementById('dialog').innerText = "Error: " + error.message;
        });
    }

    function resetOrder() {
        // Reset frontend UI
        document.getElementById('input').value = '';
        document.getElementById('input').style.display = '';
        document.getElementById('voiceBtn').style.display = '';
        let sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        document.getElementById('newOrderBtn').style.display = 'none';
        document.getElementById('summary').innerText = '';
        update_key = '';
        sendAnswer(true);
    }
    </script>
</body>
</html>
